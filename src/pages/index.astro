---
import BaseLayout from '../layouts/BaseLayout.astro';
import kjvBible from '../data/en_kjv.json';
import rvrBible from '../data/es_rvr.json';
import votdData from '../data/votd_data.json';

// --- BIBLE BOOK LOGIC ---
// Old Testament (First 39 books) & New Testament (Last 27 books)
const enOT = kjvBible.slice(0, 39);
const enNT = kjvBible.slice(39);

const esOT = rvrBible.slice(0, 39);
const esNT = rvrBible.slice(39);

// --- SMART DATE LOGIC ---
const date = new Date();
const todayId = `${date.getMonth() + 1}-${date.getDate()}`;

// English Verse
let votdEn = votdData.en.find(v => v.dateId === todayId);
if (!votdEn) votdEn = votdData.en.find(v => v.dateId === "default") || votdData.en[0];

// Spanish Verse
let votdEs = votdData.es.find(v => v.dateId === todayId);
if (!votdEs) votdEs = votdData.es.find(v => v.dateId === "default") || votdData.es[0];

// Images
const imgEn = votdEn.image || "/images/verses/john-3-16.jpg";
const imgEs = votdEs.image || "/images/verses/juan-3-16.jpg";

const siteUrl = Astro.url.origin;
---

<BaseLayout title="Home">
    
    <div class="text-center mb-8">
        <div class="lang-en">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800 dark:text-gray-100">
                Welcome to <span class="text-blue-600 dark:text-blue-400">ScriptureHub</span>
            </h1>
        </div>
        <div class="lang-es hidden">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800 dark:text-gray-100">
                Bienvenido a <span class="text-green-600 dark:text-green-400">ScriptureHub</span>
            </h1>
        </div>
    </div>

    <div class="max-w-4xl mx-auto bg-white dark:bg-gray-800 rounded-3xl shadow-2xl overflow-hidden mb-16 border border-gray-100 dark:border-gray-700">
        
        <div class="relative h-64 md:h-96 bg-gray-900 group">
            <img id="votd-img-en" src={imgEn} class="absolute inset-0 w-full h-full object-cover transition-opacity duration-500 opacity-100" alt={`Verse: ${votdEn.ref}`} />
            <img id="votd-img-es" src={imgEs} class="absolute inset-0 w-full h-full object-cover transition-opacity duration-500 opacity-0" alt={`Versículo: ${votdEs.ref}`} />
            
            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent"></div>
            
            <div class="absolute top-4 right-4 bg-black/40 backdrop-blur-md p-1 rounded-lg border border-white/20 flex gap-1 z-20">
                <button id="card-btn-en" class="px-3 py-1 rounded text-xs font-bold bg-white text-black shadow-sm transition-all">EN</button>
                <button id="card-btn-es" class="px-3 py-1 rounded text-xs font-bold text-white hover:bg-white/20 transition-all">ES</button>
            </div>
        </div>

        <div class="p-6 md:p-8">
            <div id="text-en" class="transition-opacity duration-300 block">
                <h2 class="text-sm font-bold text-blue-600 dark:text-blue-400 uppercase tracking-widest mb-2">Verse of the Day</h2>
                <blockquote class="text-xl md:text-2xl font-serif text-gray-800 dark:text-gray-100 leading-relaxed mb-4">"{votdEn.text}"</blockquote>
                <a href={`/en/${votdEn.abbrev}/${votdEn.chapter}/`} class="inline-block font-bold text-gray-500 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">- {votdEn.ref} &rarr;</a>
            </div>
            <div id="text-es" class="transition-opacity duration-300 hidden">
                <h2 class="text-sm font-bold text-green-600 dark:text-green-400 uppercase tracking-widest mb-2">Versículo del Día</h2>
                <blockquote class="text-xl md:text-2xl font-serif text-gray-800 dark:text-gray-100 leading-relaxed mb-4">"{votdEs.text}"</blockquote>
                <a href={`/es/${votdEs.abbrev}/${votdEs.chapter}/`} class="inline-block font-bold text-gray-500 hover:text-green-600 dark:hover:text-green-400 transition-colors">- {votdEs.ref} &rarr;</a>
            </div>
        </div>
    </div>

    <div class="lang-en">
        <div class="mb-12">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6 flex items-center gap-3">
                <span class="w-8 h-1 bg-blue-600 rounded-full"></span> Old Testament
            </h2>
            <ul class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                {enOT.map(book => (
                    <li><a href={`/en/${book.abbrev}/`} class="block p-3 rounded-lg bg-blue-50 dark:bg-gray-800 text-blue-900 dark:text-blue-100 hover:bg-blue-100 dark:hover:bg-gray-700 font-medium text-center transition-colors border border-blue-100 dark:border-gray-700">{book.name}</a></li>
                ))}
            </ul>
        </div>

        <div>
            <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6 flex items-center gap-3">
                <span class="w-8 h-1 bg-blue-600 rounded-full"></span> New Testament
            </h2>
            <ul class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                {enNT.map(book => (
                    <li><a href={`/en/${book.abbrev}/`} class="block p-3 rounded-lg bg-blue-50 dark:bg-gray-800 text-blue-900 dark:text-blue-100 hover:bg-blue-100 dark:hover:bg-gray-700 font-medium text-center transition-colors border border-blue-100 dark:border-gray-700">{book.name}</a></li>
                ))}
            </ul>
        </div>
    </div>

    <div class="lang-es hidden">
        <div class="mb-12">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6 flex items-center gap-3">
                <span class="w-8 h-1 bg-green-600 rounded-full"></span> Antiguo Testamento
            </h2>
            <ul class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                {esOT.map(book => (
                    <li><a href={`/es/${book.abbrev}/`} class="block p-3 rounded-lg bg-green-50 dark:bg-gray-800 text-green-900 dark:text-green-100 hover:bg-green-100 dark:hover:bg-gray-700 font-medium text-center transition-colors border border-green-100 dark:border-gray-700">{book.name}</a></li>
                ))}
            </ul>
        </div>

        <div>
            <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6 flex items-center gap-3">
                <span class="w-8 h-1 bg-green-600 rounded-full"></span> Nuevo Testamento
            </h2>
            <ul class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                {esNT.map(book => (
                    <li><a href={`/es/${book.abbrev}/`} class="block p-3 rounded-lg bg-green-50 dark:bg-gray-800 text-green-900 dark:text-green-100 hover:bg-green-100 dark:hover:bg-gray-700 font-medium text-center transition-colors border border-green-100 dark:border-gray-700">{book.name}</a></li>
                ))}
            </ul>
        </div>
    </div>

    <script is:inline>
        {
            const btnEn = document.getElementById('card-btn-en');
            const btnEs = document.getElementById('card-btn-es');
            
            // Verse Elements
            const textEn = document.getElementById('text-en');
            const textEs = document.getElementById('text-es');
            const imgEn = document.getElementById('votd-img-en');
            const imgEs = document.getElementById('votd-img-es');

            // Global Language Elements
            const langEnElements = document.querySelectorAll('.lang-en');
            const langEsElements = document.querySelectorAll('.lang-es');

            // Function to Update UI
            function updateUI(lang) {
                if (lang === 'en') {
                    // Update Verse Card
                    textEn.classList.remove('hidden');
                    textEs.classList.add('hidden');
                    imgEn.classList.remove('opacity-0');
                    imgEn.classList.add('opacity-100');
                    imgEs.classList.remove('opacity-100');
                    imgEs.classList.add('opacity-0');

                    // Update Card Buttons
                    btnEn.classList.add('bg-white', 'text-black', 'shadow-sm');
                    btnEn.classList.remove('text-white', 'hover:bg-white/20');
                    btnEs.classList.remove('bg-white', 'text-black', 'shadow-sm');
                    btnEs.classList.add('text-white', 'hover:bg-white/20');

                    // Update Whole Page (Bible Lists)
                    langEnElements.forEach(el => el.classList.remove('hidden'));
                    langEsElements.forEach(el => el.classList.add('hidden'));
                } else {
                    // Update Verse Card
                    textEs.classList.remove('hidden');
                    textEn.classList.add('hidden');
                    imgEs.classList.remove('opacity-0');
                    imgEs.classList.add('opacity-100');
                    imgEn.classList.remove('opacity-100');
                    imgEn.classList.add('opacity-0');

                    // Update Card Buttons
                    btnEs.classList.add('bg-white', 'text-black', 'shadow-sm');
                    btnEs.classList.remove('text-white', 'hover:bg-white/20');
                    btnEn.classList.remove('bg-white', 'text-black', 'shadow-sm');
                    btnEn.classList.add('text-white', 'hover:bg-white/20');

                    // Update Whole Page (Bible Lists)
                    langEsElements.forEach(el => el.classList.remove('hidden'));
                    langEnElements.forEach(el => el.classList.add('hidden'));
                }
            }

            // 1. Listen for Global Header Change (From BaseLayout)
            window.addEventListener('languageChanged', (e) => {
                updateUI(e.detail);
            });

            // 2. Handle Card Button Clicks -> This triggers Global Change
            btnEn.addEventListener('click', () => {
                // Dispatch event to update BaseLayout header + this page
                window.dispatchEvent(new CustomEvent('languageChanged', { detail: 'en' }));
                localStorage.setItem('lang', 'en'); // Save preference
            });

            btnEs.addEventListener('click', () => {
                window.dispatchEvent(new CustomEvent('languageChanged', { detail: 'es' }));
                localStorage.setItem('lang', 'es');
            });

            // 3. Initial Load
            const savedLang = localStorage.getItem('lang') || 'en';
            updateUI(savedLang);
        }
    </script>

</BaseLayout>