---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

export async function getStaticPaths() {
  const familyItems = await getCollection('family');
  return familyItems.map(entry => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const item = entry.data;
const { Content } = await entry.render();

const title = `${item.title} - Download`;
---

<BaseLayout title={title}>

    <a href="/family/" class="inline-block mb-6 text-gray-500 hover:text-blue-600 font-bold transition-colors">
        &larr; Back to Collection
    </a>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
        
        <div class="space-y-4">
            <div class="relative rounded-2xl overflow-hidden shadow-lg bg-gray-100 dark:bg-gray-800 aspect-square group">
                <img id="main-image" src={item.gallery[0]} class="w-full h-full object-cover transition-all duration-300" alt={item.title} />
                
                {item.gallery.length > 1 && (
                    <>
                        <button id="prev-img" class="absolute left-2 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white text-gray-800 p-2 rounded-full shadow-md opacity-0 group-hover:opacity-100 transition-opacity">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                        </button>
                        <button id="next-img" class="absolute right-2 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white text-gray-800 p-2 rounded-full shadow-md opacity-0 group-hover:opacity-100 transition-opacity">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                        </button>
                    </>
                )}
            </div>
            
            {item.gallery.length > 1 && (
                <div class="flex gap-4 overflow-x-auto pb-2 px-1">
                    {item.gallery.map((img, index) => (
                        <button 
                            class="thumbnail w-20 h-20 rounded-lg overflow-hidden border-2 border-transparent hover:border-blue-500 focus:border-blue-500 transition-all flex-shrink-0"
                            data-src={img}
                            data-index={index}
                        >
                            <img src={img} class="w-full h-full object-cover" />
                        </button>
                    ))}
                </div>
            )}
        </div>

        <div>
            <div class="flex items-center gap-3 mb-4">
                <span class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wider">
                    {item.type}
                </span>
                {item.print_link && (
                    <span class="bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wider">
                        Print Available
                    </span>
                )}
            </div>
            
            <h1 class="text-4xl font-extrabold text-gray-900 dark:text-gray-100 mb-6">
                {item.title}
            </h1>
            
            <div class="prose prose-lg dark:prose-invert text-gray-600 dark:text-gray-300 mb-8">
                <Content />
            </div>

            <div class="space-y-4">
                
                <div class="bg-gray-50 dark:bg-gray-800 p-6 rounded-2xl border border-gray-200 dark:border-gray-700">
                    <h3 class="font-bold text-gray-800 dark:text-gray-200 mb-1">Digital Version (PDF)</h3>
                    <p class="text-sm text-gray-500 mb-4">Instant download. Print at home.</p>
                    
                    <a href={item.digital_link} target="_blank" class="flex items-center justify-center gap-2 w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl text-lg shadow-lg transition-transform transform hover:-translate-y-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        Get for FREE
                    </a>
                    <p class="text-xs text-center text-gray-400 mt-3">
                        Use code <strong class="text-blue-600 dark:text-blue-400">FREE</strong> at checkout for 100% discount.
                    </p>
                </div>

                {item.print_link && (
                    <div class="bg-purple-50 dark:bg-purple-900/20 p-6 rounded-2xl border border-purple-200 dark:border-purple-700/50">
                        <h3 class="font-bold text-purple-900 dark:text-purple-100 mb-1">Want a Printed Copy?</h3>
                        <p class="text-sm text-purple-700 dark:text-purple-300 mb-4">Get a high-quality physical version shipped to you.</p>
                        
                        <a href={item.print_link} target="_blank" class="flex items-center justify-center gap-2 w-full py-4 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl text-lg shadow-lg transition-transform transform hover:-translate-y-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" /></svg>
                            {item.print_label || "Buy Physical Copy"}
                        </a>
                    </div>
                )}

            </div>
        </div>
    </div>

    <script is:inline define:vars={{ gallery: item.gallery }}>
        const mainImage = document.getElementById('main-image');
        const thumbnails = document.querySelectorAll('.thumbnail');
        const prevBtn = document.getElementById('prev-img');
        const nextBtn = document.getElementById('next-img');
        
        let currentIndex = 0;

        function updateImage(index) {
            if (index < 0) index = gallery.length - 1;
            if (index >= gallery.length) index = 0;
            
            currentIndex = index;
            mainImage.src = gallery[currentIndex];
            
            thumbnails.forEach((thumb, i) => {
                if(i === currentIndex) thumb.classList.add('border-blue-500');
                else thumb.classList.remove('border-blue-500');
            });
        }

        thumbnails.forEach((btn, index) => {
            btn.addEventListener('click', () => updateImage(index));
        });

        if(prevBtn) prevBtn.addEventListener('click', () => updateImage(currentIndex - 1));
        if(nextBtn) nextBtn.addEventListener('click', () => updateImage(currentIndex + 1));
    </script>

</BaseLayout>