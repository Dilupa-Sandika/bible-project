---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

export async function getStaticPaths() {
  const familyItems = await getCollection('family');
  return familyItems.map(entry => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const item = entry.data;
const { Content } = await entry.render();

// Title is handled dynamically
---

<BaseLayout title={item.title_en}>

    <div class="mb-6">
        <a href="/family/" class="inline-block text-gray-500 hover:text-blue-600 font-bold transition-colors lang-en">&larr; Back to Collection</a>
        <a href="/family/" class="inline-block text-gray-500 hover:text-green-600 font-bold transition-colors lang-es hidden">&larr; Volver a la Colección</a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
        
        <div class="space-y-4">
            <div class="relative rounded-2xl overflow-hidden shadow-lg bg-gray-100 dark:bg-gray-800 aspect-square group">
                
                <img id="main-image" src={item.gallery[0]} class="w-full h-full object-cover transition-all duration-300" alt={item.title_en} />
                
                {item.gallery.length > 1 && (
                    <>
                        <button id="prev-img" class="absolute left-2 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white text-gray-800 p-2 rounded-full shadow-md opacity-0 group-hover:opacity-100 transition-opacity z-10">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                        </button>
                        <button id="next-img" class="absolute right-2 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white text-gray-800 p-2 rounded-full shadow-md opacity-0 group-hover:opacity-100 transition-opacity z-10">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                        </button>
                    </>
                )}
            </div>
            
            {item.gallery.length > 1 && (
                <div class="flex gap-4 overflow-x-auto pb-2 px-1">
                    {item.gallery.map((img, index) => (
                        <button 
                            class="thumbnail w-20 h-20 rounded-lg overflow-hidden border-2 border-transparent hover:border-blue-500 focus:border-blue-500 transition-all flex-shrink-0"
                            data-src={img}
                            data-index={index}
                            onclick={`updateImage(${index})`} 
                        >
                            <img src={img} class="w-full h-full object-cover" />
                        </button>
                    ))}
                </div>
            )}
        </div>

        <div>
            <div class="flex items-center gap-3 mb-4">
                <span class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wider">
                    {item.type}
                </span>
                {item.is_premium && (
                    <span class="bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wider">
                        Premium
                    </span>
                )}
            </div>
            
            <h1 class="text-4xl font-extrabold text-gray-900 dark:text-gray-100 mb-6 lang-en">{item.title_en}</h1>
            <h1 class="text-4xl font-extrabold text-gray-900 dark:text-gray-100 mb-6 lang-es hidden">{item.title_es}</h1>
            
            <div class="prose prose-lg dark:prose-invert text-gray-600 dark:text-gray-300 mb-8">
                <Content />
            </div>

            <div class="space-y-4">
                
                <div class="bg-gray-50 dark:bg-gray-800 p-6 rounded-2xl border border-gray-200 dark:border-gray-700">
                    <div class="lang-en">
                        <h3 class="font-bold text-gray-800 dark:text-gray-200 mb-1">Digital Version (PDF)</h3>
                        <p class="text-sm text-gray-500 mb-4">Instant download.</p>
                        <a href={item.digital_link} target="_blank" class="flex items-center justify-center gap-2 w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl text-lg shadow-lg transition-transform transform hover:-translate-y-1">
                            Get for FREE
                        </a>
                        <p class="text-xs text-center text-gray-400 mt-3">Use code <strong>FREE</strong></p>
                    </div>
                    <div class="lang-es hidden">
                        <h3 class="font-bold text-gray-800 dark:text-gray-200 mb-1">Versión Digital (PDF)</h3>
                        <p class="text-sm text-gray-500 mb-4">Descarga instantánea.</p>
                        <a href={item.digital_link} target="_blank" class="flex items-center justify-center gap-2 w-full py-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl text-lg shadow-lg transition-transform transform hover:-translate-y-1">
                            Descargar GRATIS
                        </a>
                        <p class="text-xs text-center text-gray-400 mt-3">Usa el código <strong>FREE</strong></p>
                    </div>
                </div>

                {item.print_link && (
                    <div class="bg-purple-50 dark:bg-purple-900/20 p-6 rounded-2xl border border-purple-200 dark:border-purple-700/50">
                        <div class="lang-en">
                            <h3 class="font-bold text-purple-900 dark:text-purple-100 mb-1">Want a Printed Copy?</h3>
                            <a href={item.print_link} target="_blank" class="flex items-center justify-center gap-2 w-full py-4 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl text-lg shadow-lg transition-transform transform hover:-translate-y-1">
                                {item.print_label_en || "Buy Physical Copy"}
                            </a>
                        </div>
                        <div class="lang-es hidden">
                            <h3 class="font-bold text-purple-900 dark:text-purple-100 mb-1">¿Quieres una copia impresa?</h3>
                            <a href={item.print_link} target="_blank" class="flex items-center justify-center gap-2 w-full py-4 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl text-lg shadow-lg transition-transform transform hover:-translate-y-1">
                                {item.print_label_es || "Comprar Copia Física"}
                            </a>
                        </div>
                    </div>
                )}
            </div>
        </div>
    </div>

    <script is:inline define:vars={{ gallery: item.gallery }}>
        // Block Scope
        {
            // --- LANGUAGE LOGIC ---
            function updateDetailPageLang(lang) {
                const enElements = document.querySelectorAll('.lang-en');
                const esElements = document.querySelectorAll('.lang-es');

                if (lang === 'es') {
                    enElements.forEach(el => el.classList.add('hidden'));
                    esElements.forEach(el => el.classList.remove('hidden'));
                } else {
                    esElements.forEach(el => el.classList.add('hidden'));
                    enElements.forEach(el => el.classList.remove('hidden'));
                }
            }

            // Listen for global event from BaseLayout
            window.addEventListener('languageChanged', (e) => {
                updateDetailPageLang(e.detail);
            });

            // Check initial state
            const currentLang = localStorage.getItem('lang') || 'en';
            updateDetailPageLang(currentLang);


            // --- IMAGE SLIDER LOGIC ---
            const mainImage = document.getElementById('main-image');
            const thumbnails = document.querySelectorAll('.thumbnail');
            const prevBtn = document.getElementById('prev-img');
            const nextBtn = document.getElementById('next-img');
            
            let currentIndex = 0;

            // Global function for onclick calls
            window.updateImage = (index) => {
                if (index < 0) index = gallery.length - 1;
                if (index >= gallery.length) index = 0;
                
                currentIndex = index;
                mainImage.src = gallery[currentIndex];
                
                thumbnails.forEach((thumb, i) => {
                    if(i === currentIndex) thumb.classList.add('border-blue-500');
                    else thumb.classList.remove('border-blue-500');
                });
            }

            if(prevBtn) prevBtn.addEventListener('click', () => window.updateImage(currentIndex - 1));
            if(nextBtn) nextBtn.addEventListener('click', () => window.updateImage(currentIndex + 1));
        }
    </script>

</BaseLayout>