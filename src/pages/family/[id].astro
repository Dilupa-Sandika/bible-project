---
import BaseLayout from '../../layouts/BaseLayout.astro';
import familyItems from '../../data/family_db.json';

export async function getStaticPaths() {
  return familyItems.map(item => ({
    params: { id: item.id },
    props: { item },
  }));
}

const { item } = Astro.props;
const title = `${item.title} - Download`;
---

<BaseLayout title={title}>

    <a href="/family/" class="inline-block mb-6 text-gray-500 hover:text-blue-600 font-bold transition-colors">
        &larr; Back to Collection
    </a>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
        
        <div class="space-y-4">
            <div class="relative rounded-2xl overflow-hidden shadow-lg bg-gray-100 dark:bg-gray-800 aspect-square group">
                <img id="main-image" src={item.gallery[0]} class="w-full h-full object-cover" alt={item.title} />
            </div>
            
            {item.gallery.length > 1 && (
                <div class="flex gap-4 overflow-x-auto pb-2">
                    {item.gallery.map((img, index) => (
                        <button 
                            class="w-20 h-20 rounded-lg overflow-hidden border-2 border-transparent hover:border-blue-500 focus:border-blue-500 transition-all flex-shrink-0"
                            onclick={`document.getElementById('main-image').src = '${img}'`}
                        >
                            <img src={img} class="w-full h-full object-cover" />
                        </button>
                    ))}
                </div>
            )}
        </div>

        <div>
            <span class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wider">
                {item.type} / {item.filter_tag}
            </span>
            
            <h1 class="text-4xl font-extrabold text-gray-900 dark:text-gray-100 mt-4 mb-4">
                {item.title}
            </h1>
            
            <p class="text-lg text-gray-600 dark:text-gray-400 leading-relaxed mb-8">
                {item.description}
            </p>

            {item.is_premium ? (
                <a href={item.file_link} target="_blank" class="block w-full py-4 text-center bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl text-lg shadow-lg transition-transform transform hover:-translate-y-1">
                    Buy on Etsy ($)
                </a>
            ) : (
                <div class="bg-gray-50 dark:bg-gray-800 p-6 rounded-2xl border border-gray-200 dark:border-gray-700">
                    <h3 class="font-bold text-gray-800 dark:text-gray-200 mb-2">Free Download</h3>
                    <p class="text-sm text-gray-500 mb-4">Enter your email to unlock the download link instantly.</p>
                    
                    <button 
                        id="open-modal"
                        class="block w-full py-4 text-center bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl text-lg shadow-lg transition-transform transform hover:-translate-y-1"
                    >
                        Download Now
                    </button>
                </div>
            )}
        </div>
    </div>

    <div id="email-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 rounded-3xl max-w-md w-full p-8 relative shadow-2xl">
            <button id="close-modal" class="absolute top-4 right-4 text-gray-400 hover:text-red-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            
            <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4 text-center">Almost There! üéÅ</h3>
            
            <form id="download-form" class="space-y-4">
                <input type="email" placeholder="Enter your email" required class="w-full px-4 py-3 rounded-xl border dark:bg-gray-700 dark:border-gray-600" />
                <button type="submit" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl">
                    Get File
                </button>
            </form>
        </div>
    </div>

    <script is:inline define:vars={{ fileLink: item.file_link }}>
        const modal = document.getElementById('email-modal');
        const openBtn = document.getElementById('open-modal');
        const closeBtn = document.getElementById('close-modal');
        const form = document.getElementById('download-form');

        if(openBtn) openBtn.addEventListener('click', () => modal.classList.remove('hidden'));
        if(closeBtn) closeBtn.addEventListener('click', () => modal.classList.add('hidden'));

        if(form) {
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                // Simulate Email Capture
                setTimeout(() => {
                    window.open(fileLink, '_blank');
                    modal.classList.add('hidden');
                }, 1000);
            });
        }
    </script>

</BaseLayout>