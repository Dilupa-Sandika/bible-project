---
// 1. Layout එක import කරනවා
import BaseLayout from '../../../layouts/BaseLayout.astro';
import kjvBible from '../../../data/en_kjv.json';

export async function getStaticPaths() {
  const paths = [];
  kjvBible.forEach(book => {
    book.chapters.forEach((chapter, index) => {
      const chapterNumber = index + 1;
      paths.push({
        params: { book: book.abbrev, chapter: chapterNumber.toString() }
      });
    });
  });
  return paths;
}

const { book: bookAbbrev, chapter: chapterNumberStr } = Astro.params;
const chapterNumber = parseInt(chapterNumberStr); 
const currentBook = kjvBible.find(b => b.abbrev === bookAbbrev);
const currentChapterVerses = currentBook.chapters[chapterNumber - 1];

const totalChapters = currentBook.chapters.length;
const prevChapter = chapterNumber > 1 ? chapterNumber - 1 : null;
const nextChapter = chapterNumber < totalChapters ? chapterNumber + 1 : null;

const bookNumber = kjvBible.indexOf(currentBook) + 1;
const audioSrc = `https://www.wordproject.org/bibles/app/audio/1/${bookNumber}/${chapterNumber}.mp3`;

// 2. Page Title එක Layout එකට pass කරනවා
const title = `${currentBook.name} ${chapterNumber}`;
---
<BaseLayout title={title}>

    <div class="mb-4 text-sm text-gray-600 dark:text-gray-400">
        <a href="/" class="text-blue-600 dark:text-blue-400 hover:underline">Home</a>
        <span class="mx-2">&gt;</span>
        <a href={`/en/${bookAbbrev}/`} class="text-blue-600 dark:text-blue-400 hover:underline">{currentBook.name}</a>
        <span class="mx-2">&gt;</span>
        <span class="font-semibold">Chapter {chapterNumber}</span>
    </div>
    
    <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100 mb-6">
        {currentBook.name} - Chapter {chapterNumber}
    </h1>

    <div class="my-6 border-t border-b border-gray-200 dark:border-gray-700 py-4">
        <audio controls class="w-full">
            <source src={audioSrc} type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>
    </div>

    <ol class="text-gray-800 dark:text-gray-200 text-lg leading-relaxed space-y-4">
        {currentChapterVerses.map((verseText, index) => {
            const verseNumber = index + 1;
            return (
                <li class="flex">
                    <sup class="font-bold text-blue-600 dark:text-blue-400 mr-2 shrink-0">{verseNumber}</sup>
                    <span>{verseText}</span>
                </li>
            )
        })}
    </ol>

    <nav class="flex flex-col sm:flex-row justify-between border-t border-gray-200 dark:border-gray-700 pt-6 mt-8 gap-4">
        {prevChapter ? (
            <a href={`/en/${bookAbbrev}/${prevChapter}/`} class="text-center px-5 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700 font-medium transition-colors">
                &larr; Chapter {prevChapter}
            </a>
        ) : (
            <span class="text-center px-5 py-3 rounded-lg bg-gray-300 dark:bg-gray-700 text-gray-500 dark:text-gray-400 cursor-not-allowed">&larr; Previous</span>
        )}
        
        {nextChapter ? (
            <a href={`/en/${bookAbbrev}/${nextChapter}/`} class="text-center px-5 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700 font-medium transition-colors">
                Chapter {nextChapter} &rarr;
            </a>
        ) : (
            <span class="text-center px-5 py-3 rounded-lg bg-gray-300 dark:bg-gray-700 text-gray-500 dark:text-gray-400 cursor-not-allowed">Next &rarr;</span>
        )}
    </nav>
</BaseLayout>